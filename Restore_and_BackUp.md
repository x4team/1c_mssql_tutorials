 ## ВОССТАНОВЛЕНИЕ И БЭКАП ИЗ ЖУРНАЛА ТРАНЗАКЦИЙ
 
 0) Проверить модель восстановления в свойствах БД (Полная): 

 Если простая модель восстановления - см ниже после пункта 7

1) ВАЖНО, для этих бэкапов ЖТ нужен обязательно ПОЛНЫЙ БЭКАП (к примеру делаем его ночью), а уже ЖТ в течении дня через каждые 30 мин

* Так же можно задать полный бэкап в обед (ВАЖНО, что при полном бэкапе могут быть сильные тормоза для пользователей)

Если пользователей мало и база не большая, то можно делать ПОЛНЫЙ бэкап каждые 30 минут.

2) Делаем полный бэкап - ПКМ по базе - задачи - создать резервную копию - в Назначении указываем НА ДИСК (если в списке указано в другое место - удаляем из списка сначала) И жмем ОК - создать

3) ДЕЛАЕМ БЭКАП ЖТ. ПКМ по базе - задачи - создать резер копию - выбираем Журнал Транзакций. В назначении удаляем если есть что-то в списке и жмем Добавить и указываем место назначения. Жмем ОК создать

4) ВОССТАНАВЛИВАЕМ! ПКМ по базе - задачи - восстановить и выбираем файл ПОЛНОГО БЭКАПА, ставим галочку " Восстановить" и переходим на вкладку "Параметры" и ставим галочку "Перезаписывать существующую БД ...." и ОБЯЗАТЕЛЬНО "Оставить БД в неработающем состоянии.."

Теперь главное чтобы все пользователи вышли из 1С или перевести SQL сервер в однопользовательский режим. КЛикаем ОК и восстанавливаем

Теперь БД перешла в режим ВОССТАНОВЛЕНИЯ

5) Также ПКМ-задачи-восстановить-файлы и файловые группы. Выбираем "С устройства" и выбираем первый журнал транзакций по времени после ПОЛНОГО БЭКАПА. И один за другим накатываем до нужного времени. (После выбора файла ставим галочку "Восстановить" и во вкладке Параметры также ставим галочку "Оставить БД в неработающем.." 

В ПАРАМЕТРАХ восстановления НЕ СТАВИТЬ галочки "Перезаписать... " и тд. ЖМЕМ ОК и восстанавливаем

6) МЫ МОЖЕМ БЫСТРО ВОССТАНОВИТЬ ИСПОЛЬЗУЯ ВОССТАНОВЛЕНИЕ В МЕНЮ "Журналы транзакций"

ПКМ - задачи -восстановить - журналы транзакций

7) SQL сервер должен найти все бэкапы журнала транзакций. Выбрать нужные и исключить не нужные. Жмем ОК восстановить

Также снизу "На момент времени" если кликнуть справа то можно выбрать КОНКРЕТНОЕ ВРЕМЯ



## ЕСЛИ ПРОСТАЯ МОДЕЛЬ ВОССТАНОВЛЕНИЯ, то действия такие:

https://www.youtube.com/watch?v=wb6jEqH1bro

0) Проверить модель восстановления в свойствах БД:

1) Перед всеми действиями пр кнопкой мыши -> задачи -> создать резервную копию(полная). Выбираем диск или NAS

И в "параметрах носителя" оставлять все по умолчанию, но на ГЛАВНОЙ вкладке всегда НОВЫй файл носитель!

1.1) Также в "параметрах носителя" поставить галочку "Проверить резервную копию после завершения"

* B обязательно проверять бэкапы на восстановление в тестовой среде

1.2) В параметрах резервного копирования НИ В КОЕМ случае НЕ СЖИМАТЬ РЕЗЕВРЕНЫЙ КОПИИ!!!

2) Теперь ВОССТАНАВЛИВАЕМ. ПКМ по базе - задачи - восстановить - файлы и файловые группы

3.1) В базу данных указываем целевую, и источник "с устройства". Выбираем файл и ставим галочку "Восстановить"

4) На вкладке ПАРАМЕТРЫ - Параметры восстановления  убрать все галочки.

В блоке "Восстановить файлы базы данных как" должны указаны наши mdf и ldf

В блоке "Состояние воссстановления" оставляем базу данных готовой к использованию

*НЕ РЕКОМЕНДАУЕТСЯ ПЕРЕЗАПИСЫВАТЬ БД, только в самых крайних случаях!

*ОБЯЗАТЕЛЬНО при восстановлении НЕ должно быть активных пользователей.

5) Жмем ОК, то есть "Восстановить" и проверяем после восстановления что бэкап успешно восстановился

### 6) ТЕПЕРЬ ПОПРОБУЕМ СОЗДАТЬ РАЗНОСТНЫЙ БЭКАП (дифференциальный)

* ВАЖНО! Создается ТОЛЬКО после полного бэкапа

7) ПКМ по базе -задачи - создать резервную копию, и ТИП АРХИВНОЙ КОПИИ - выбрать РАЗНОСТНЫЙ

В НАЗНАЧЕНИИ удалить ИЗ СПИСКА файл с набором данных. Жмем ДОБАВИТЬ и выбираем путь и имя бэкапа. ОК и создаем БЭКАП.

8) Идем в каталог бэкапов и проверям присутствие созданного файла бэкапа

* ВНИМАНИЕ! НЕ ЗАБЫВАЕМ, что копия содержит ТОЛЬКО ИЗМЕНЕНИЯ

И РАЗМЕР РАЗНОСТНОГО БЭКАПА НЕ МАЛЕНЬКИЙ. ПОЭТОМУ лчуше в полной модели восстановления делать БЭКАПЫ журналов транзакций, А НЕ разностные бэкапы

* В ПРОСТОЙ модели восстановления мы НЕ МОЖЕМ восстанавливаться на определенный отрезок времени, а только тогда когда был сделан бэкап

9) ТЕПЕРЬ ВОССТАНАВЛИВАЕМ - ПКМ по базе - задачи - восстановить - файлы и файловые группы - с устройства. 

10) Выбираем сначала ПОЛНЫЙ бэкап с устройства и ставим галочку "Восстановить" .

11) И во вкладке ПАРАМЕТРЫ указываем "Оставить базу данных в неработающем состоянии". В блоке "Параметры восстановления" ничего не ставим и жмем ОК ВОССТАНОВИТЬ

12) ТЕперь наша база в состоянии "БАЗА НЕ ДОСТУПНА" и также накатываем поверх с теми же параметрами, но выбираем РАЗНОСТНЫЙ БЭКАП и на вкладке "ПАРАМЕТРЫ" ставим галочку "Оставить базу данных готовой к использованию" и готово!

### ТЕПЕРЬ РАЗБЕРЕМ восстановления используя базу данных, а не файлы и файловые группы!

* этот вариант восстановления НЕ ЗАМЕНИМ когда мы используем восстановление при помощи журналов транзакций, так как конкретно позволяет указать КОНКРЕТНУЮ ТОЧКУ ВРЕМЕНИ при восстановление, чего нельзя сделать когда мы восстанавливаем файлы и файловые группы.

0) ПКМ по базе - задачи - восстановить - БАЗА дынных

1) На вкладке ОБЩИЕ выбираем устройство и добавляем ПОЛНЫЙ БЭКАП и сразу также добавляем РАЗНОСТНЫЙ бэкап и кликаем ОК.

2) В поле восстановление кликаем кнопку ВРЕМЕННАЯ, и если мы выбираем "Указать время и дату", то по шкале можем выбирать удобно момент времени ДОСТУПНЫЙ для нас из того набора данных что указали в 1 пункте

* Время указать мы не можем, так как у нас бэкап НЕ журнала транзакций

3) НА вкладке Общие в блоке "восстанавлевыемые наборры данных" обязательно снизу для каждого файла кликнуть по кнопка "Проверить носитель резервной копии"

4) И на вкладке ПАРАМЕТРЫ мы можем поставить галочку "Закрыть соединения с БД" для надежности что нет активных соединений

5) На вкладке ФАЙЛЫ обязательно ИСХОДНОЕ ИМЯ ФАЙЛА и ВОССТАНОВИТЬ КАК должны быть одни и теже файлы и пути

6) Кликаем ОК и пробуем восстановиться





![]()
![]()
![]()
![]()
![]()
![]()
![]()
![]()
![]()
![]()
![]()
![]()
![]()
![]()
